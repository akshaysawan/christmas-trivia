<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Party Trivia</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Poppins:wght@400;600&family=Cinzel:wght@700&family=Pacifico&display=swap" rel="stylesheet">

    <style>
        /* THEME CONFIGURATIONS */
        :root {
            /* Default to Christmas */
            --primary-color: #D42426;       /* Red */
            --secondary-color: #2F5233;     /* Green */
            --accent-color: #F1D570;        /* Gold */
            --text-on-primary: #fff;
            --bg-color: #2F5233;
            --card-bg: rgba(255, 255, 255, 0.95);
            --header-font: 'Mountains of Christmas', cursive;
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='52' height='26' viewBox='0 0 52 26' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M10 10c0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6h2c0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4v2c-2.21 0-4-1.79-4-4 0-3.314-2.686-6-6-6-2.21 0-4-1.79-4-4-3.314 0-6-2.686-6-6zM32 22c0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6h2c0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4v2c-2.21 0-4-1.79-4-4-3.314 0-6-2.686-6-6-2.21 0-4-1.79-4-4-3.314 0-6-2.686-6-6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        [data-theme="newyear"] {
            --primary-color: #000000;       /* Black */
            --secondary-color: #B8860B;     /* Dark Gold */
            --accent-color: #FFD700;        /* Gold */
            --text-on-primary: #FFD700;
            --bg-color: #1a1a1a;
            --header-font: 'Cinzel', serif;
            --bg-pattern: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23FFD700' fill-opacity='0.1'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        [data-theme="diwali"] {
            --primary-color: #E65100;       /* Deep Orange */
            --secondary-color: #4A148C;     /* Deep Purple */
            --accent-color: #FFD600;        /* Bright Yellow */
            --text-on-primary: #fff;
            --bg-color: #311B92;            /* Indigo */
            --header-font: 'Poppins', sans-serif; 
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23FFD600' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        [data-theme="holi"] {
            --primary-color: #E91E63;       /* Pink */
            --secondary-color: #00BCD4;     /* Cyan */
            --accent-color: #FFEB3B;        /* Yellow */
            --text-on-primary: #fff;
            --bg-color: #E91E63;
            --header-font: 'Pacifico', cursive;
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.2'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        }

        body {
            background-color: var(--bg-color);
            background-image: var(--bg-pattern);
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            transition: background-color 0.5s ease, background-image 0.5s ease;
        }

        .main-card {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 4px solid var(--accent-color);
            min-height: 80vh; /* Increased height for splitscreen */
            position: relative;
            overflow: hidden;
            transition: border-color 0.5s ease;
            display: flex;
            flex-direction: column;
        }

        .decorative-header {
            background: var(--primary-color);
            color: var(--text-on-primary);
            font-family: var(--header-font);
            padding: 15px;
            text-align: center;
            font-size: 2.5rem;
            position: relative;
            transition: all 0.5s ease;
            flex-shrink: 0;
        }

        .decorative-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 20px;
            background: radial-gradient(circle, var(--accent-color) 6px, transparent 7px) repeat-x;
            background-size: 30px 20px;
        }

        .card-body {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .top-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .upload-area {
            border: 3px dashed var(--secondary-color);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: rgba(255, 255, 255, 0.5);
            color: #333;
        }

        .upload-area:hover {
            background-color: rgba(255, 255, 255, 0.8);
            border-color: var(--primary-color);
        }

        .question-text {
            font-size: 2rem;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 2rem;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.5s ease;
        }

        .answer-box {
            background-color: var(--primary-color);
            color: var(--text-on-primary);
            padding: 20px;
            border-radius: 10px;
            font-size: 1.5rem;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            transition: all 0.5s ease;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .answer-box.hidden {
            background-color: #e9ecef;
            color: transparent;
            position: relative;
        }

        .answer-box.hidden::after {
            content: 'Click to Reveal Answer';
            color: #6c757d;
            position: absolute;
            font-size: 1rem;
            font-weight: bold;
        }

        .btn-custom {
            border-radius: 50px;
            padding: 10px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: transform 0.2s, background-color 0.5s;
        }

        .btn-custom:hover {
            transform: scale(1.05);
        }

        .btn-next {
            background-color: var(--secondary-color);
            border: none;
            color: white;
        }

        .btn-prev {
            background-color: #6c757d;
            border: none;
            color: white;
        }

        .progress-bar-container {
            height: 10px;
            background-color: #e9ecef;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease, background-color 0.5s;
        }

        .snowflake {
            position: fixed;
            top: -10px;
            color: white;
            font-size: 1em;
            animation: fall linear forwards;
            z-index: 1;
            pointer-events: none;
        }

        /* --- SIDEBAR SCOREBOARD STYLES --- */
        .sidebar-container {
            border-left: 2px solid #eee;
            padding-left: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .sidebar-title {
            font-family: var(--header-font);
            color: var(--primary-color);
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px dashed var(--accent-color);
            padding-bottom: 10px;
        }

        .team-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
            position: relative;
        }

        .team-card.leader {
            border: 2px solid var(--accent-color);
            background-color: rgba(241, 213, 112, 0.1); /* light gold bg */
        }

        .team-card.leader::after {
            content: 'ðŸ‘‘';
            position: absolute;
            top: -10px;
            right: -5px;
            font-size: 1.2rem;
        }

        .team-name {
            font-weight: bold;
            color: var(--secondary-color);
            display: block;
        }

        .team-players {
            font-size: 0.8rem;
            color: #777;
            display: block;
            margin-top: 2px;
        }

        .team-score {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--secondary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Adjust scoring buttons */
        .scoring-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .scoring-controls.visible {
            opacity: 1;
        }

        .leaderboard-item {
            background: rgba(255,255,255,0.8);
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
        }

        .leaderboard-item.winner {
            background: var(--accent-color);
            color: var(--secondary-color);
            font-weight: bold;
            transform: scale(1.1);
            border: 3px solid var(--primary-color);
        }

        @keyframes fall {
            to { transform: translateY(105vh); }
        }

        .d-none-custom { display: none !important; }
        
        /* Mobile adjustment for sidebar */
        @media (max-width: 768px) {
            .sidebar-container {
                border-left: none;
                border-top: 2px solid #eee;
                padding-left: 0;
                padding-top: 20px;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body data-theme="christmas">

<audio id="bg-music" loop>
    <source src="" type="audio/ogg">
</audio>

<div class="top-controls">
    <button class="btn btn-sm btn-light shadow-sm d-none-custom" id="music-btn" onclick="toggleMusic()">
        <i class="fas fa-music"></i>
    </button>
    <select class="form-select form-select-sm shadow-sm" style="width: auto;" id="themeSelect" onchange="changeTheme(this.value)">
        <option value="christmas" selected>ðŸŽ„ Christmas</option>
        <option value="newyear">ðŸ¥‚ New Year</option>
        <option value="diwali">ðŸª” Diwali</option>
        <option value="holi">ðŸŽ¨ Holi</option>
    </select>
</div>

<div class="container-fluid px-lg-5"> <!-- Wider Container -->
    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-12">
            
            <div class="main-card">
                <div class="decorative-header">
                    <i id="theme-icon" class="fas fa-holly-berry me-2"></i> 
                    <span id="theme-title">Micron Holiday Trivia</span> 
                    <i id="theme-icon-2" class="fas fa-gift ms-2"></i>
                </div>

                <div class="card-body p-4">
                    
                    <div id="error-message" class="alert alert-danger d-none-custom" role="alert"></div>

                    <!-- WELCOME -->
                    <div id="welcome-screen" class="text-center py-4 flex-grow-1 d-flex flex-column justify-content-center">
                        <div class="mb-4">
                             <i class="fas fa-glass-cheers fa-3x" style="color: var(--accent-color); opacity: 0.5"></i>
                        </div>
                        <h1 class="display-4 mb-4" style="font-family: var(--header-font); color: var(--primary-color);">Welcome to the Party!</h1>
                        <p class="lead mb-5 text-muted">Grab a snack, find a team, and get ready for some trivia.</p>
                        
                        <div class="d-grid gap-3 col-md-6 mx-auto">
                            <button class="btn btn-lg btn-custom btn-next py-3" onclick="enterSetup()">
                                <i class="fas fa-play me-2"></i> Let's Play!
                            </button>
                        </div>
                        <div class="mt-3">
                             <small class="text-muted" id="restore-msg"></small>
                        </div>
                    </div>

                    <!-- SETUP -->
                    <div id="setup-screen" class="text-center d-none-custom flex-grow-1">
                        <h3 class="mb-4" style="color: var(--secondary-color)">Game Setup</h3>
                        
                        <div class="row g-3 justify-content-center">
                            <div class="col-md-5">
                                <div class="upload-area h-100" id="drop-zone-q">
                                    <i class="fas fa-question-circle fa-2x mb-2" style="color: var(--secondary-color)"></i>
                                    <h6>1. Upload Questions (CSV)</h6>
                                    <small class="text-muted d-block mb-2">Col 1: Question, Col 2: Answer</small>
                                    <span id="q-file-label" class="badge bg-secondary">No file chosen</span>
                                    <input type="file" id="csvFile" accept=".csv" class="d-none">
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="upload-area h-100" id="drop-zone-t">
                                    <i class="fas fa-users fa-2x mb-2" style="color: var(--secondary-color)"></i>
                                    <h6>2. Upload Teams (CSV)</h6>
                                    <small class="text-muted d-block mb-2">Col 1: Team Name, Col 2: Players</small>
                                    <span id="t-file-label" class="badge bg-secondary">No file chosen (Optional)</span>
                                    <input type="file" id="teamFile" accept=".csv" class="d-none">
                                </div>
                            </div>
                        </div>

                        <div class="form-check d-inline-block my-4">
                            <input class="form-check-input" type="checkbox" checked id="skipHeader">
                            <label class="form-check-label" for="skipHeader">Skip first row (Headers)</label>
                        </div>

                        <div class="mt-2">
                             <button class="btn btn-lg btn-custom btn-next" onclick="processAllFiles()">Start Game</button>
                        </div>

                        <div class="mt-4">
                            <p class="text-muted small mb-2">Download Game Files:</p>
                            <div class="d-flex justify-content-center gap-2">
                                <a href="questions.csv" download class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-download me-1"></i> questions.csv
                                </a>
                                <a href="TeamNames.csv" download class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download me-1"></i> TeamNames.csv
                                </a>
                            </div>
                             <div class="mt-2">
                                <button class="btn btn-sm btn-link text-muted" onclick="downloadTemplates()" style="text-decoration: none; font-size: 0.8rem;">
                                    (Or generate sample templates)
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- GAME (SPLIT LAYOUT) -->
                    <div id="game-screen" class="d-none-custom flex-grow-1">
                        <div class="row h-100">
                            <!-- LEFT: GAME AREA -->
                            <div class="col-md-9 d-flex flex-column">
                                <div class="d-flex justify-content-between text-muted mb-2">
                                    <span id="question-counter">Question 1 of 10</span>
                                    <span id="score-display">Use arrow keys to navigate</span>
                                </div>
                                
                                <div class="progress-bar-container">
                                    <div class="progress-fill" id="progress-bar"></div>
                                </div>

                                <div class="flex-grow-1 d-flex flex-column justify-content-center">
                                    <div class="question-text" id="question-display">Loading...</div>

                                    <div class="answer-box hidden" id="answer-display" onclick="toggleAnswer()">
                                        Answer
                                    </div>

                                    <!-- Scoring Buttons appear here -->
                                    <div id="scoring-area" class="scoring-controls">
                                        <span class="text-muted w-100 mb-2">Who got it right?</span>
                                        <!-- Buttons injected here -->
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center mt-4">
                                    <button class="btn btn-custom btn-prev" onclick="prevQuestion()"><i class="fas fa-arrow-left"></i></button>
                                    <button class="btn btn-outline-warning btn-custom" onclick="toggleAnswer()"><i class="fas fa-eye"></i> Show</button>
                                    <button class="btn btn-custom btn-next" onclick="nextQuestion()">Next <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>

                            <!-- RIGHT: SIDEBAR SCOREBOARD -->
                            <div class="col-md-3">
                                <div class="sidebar-container">
                                    <div class="sidebar-title">Leaderboard</div>
                                    <div id="sidebar-list" style="overflow-y: auto; max-height: 60vh;">
                                        <!-- Team Cards injected here -->
                                        <div class="text-muted text-center small mt-4">No teams loaded</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- END -->
                    <div id="end-screen" class="d-none-custom text-center py-4 flex-grow-1 d-flex flex-column justify-content-center">
                        <i id="end-icon" class="fas fa-trophy fa-4x mb-3" style="color: var(--accent-color)"></i>
                        <h2 class="display-4 mb-3" style="font-family: var(--header-font);">Final Scores!</h2>
                        
                        <div id="final-leaderboard" class="text-start mx-auto w-100" style="max-width: 500px;">
                            <!-- Leaderboard injected here -->
                        </div>
                        
                        <div class="mt-5">
                            <button class="btn btn-custom btn-next" onclick="resetGame()">
                                <i class="fas fa-redo me-2"></i> New Game
                            </button>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<script>
    // --- State ---
    let questions = [];
    let teams = []; // { name: "Team A", players: "John, Doe", score: 0 }
    let currentQuestionIndex = 0;
    let currentTheme = 'christmas';
    let snowInterval;
    let isMusicPlaying = false;
    
    const STORAGE_KEY = 'trivia_game_state';

    // --- DOM ---
    const screens = {
        welcome: document.getElementById('welcome-screen'),
        setup: document.getElementById('setup-screen'),
        game: document.getElementById('game-screen'),
        end: document.getElementById('end-screen')
    };
    
    const ui = {
        question: document.getElementById('question-display'),
        answer: document.getElementById('answer-display'),
        counter: document.getElementById('question-counter'),
        progress: document.getElementById('progress-bar'),
        csvFile: document.getElementById('csvFile'),
        teamFile: document.getElementById('teamFile'),
        skipHeader: document.getElementById('skipHeader'),
        error: document.getElementById('error-message'),
        themeIcon1: document.getElementById('theme-icon'),
        themeIcon2: document.getElementById('theme-icon-2'),
        endIcon: document.getElementById('end-icon'),
        themeTitle: document.getElementById('theme-title'),
        audio: document.getElementById('bg-music'),
        musicBtn: document.getElementById('music-btn'),
        qLabel: document.getElementById('q-file-label'),
        tLabel: document.getElementById('t-file-label'),
        scoringArea: document.getElementById('scoring-area'),
        sidebarList: document.getElementById('sidebar-list'),
        leaderboard: document.getElementById('final-leaderboard'),
        restoreMsg: document.getElementById('restore-msg')
    };

    // --- Themes ---
    const themes = {
        christmas: { colors: ['#D42426', '#2F5233', '#F1D570'], icon: 'fa-holly-berry', icon2: 'fa-gift', endIcon: 'fa-sleigh', snow: true, music: 'bgmusic.mp3' },
        newyear: { colors: ['#FFD700', '#C0C0C0', '#000000'], icon: 'fa-glass-cheers', icon2: 'fa-star', endIcon: 'fa-glass-cheers', snow: false, music: null },
        diwali: { colors: ['#E65100', '#FFD600', '#4A148C'], icon: 'fa-fire', icon2: 'fa-om', endIcon: 'fa-fire-alt', snow: false, music: null },
        holi: { colors: ['#E91E63', '#00BCD4', '#FFEB3B', '#4CAF50'], icon: 'fa-palette', icon2: 'fa-hand-sparkles', endIcon: 'fa-smile-beam', snow: false, music: null }
    };

    // --- Logic ---

    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            ui.restoreMsg.innerHTML = '<button class="btn btn-sm btn-link" onclick="restoreGame()">Resume previous game?</button>';
        }
        changeTheme('christmas');
        switchScreen('welcome');
        startSnow();
    }

    function enterSetup() {
        playMusicSafe();
        switchScreen('setup');
    }

    function playMusicSafe() {
        if (themes[currentTheme].music && ui.audio.paused) {
            ui.audio.play().then(() => { isMusicPlaying = true; updateMusicBtnUI(); })
            .catch(e => console.log("Audio waiting for interaction"));
        }
    }

    // --- File Handling ---
    document.getElementById('drop-zone-q').onclick = () => ui.csvFile.click();
    document.getElementById('drop-zone-t').onclick = () => ui.teamFile.click();

    ui.csvFile.onchange = (e) => ui.qLabel.textContent = e.target.files[0]?.name || "No file chosen";
    ui.teamFile.onchange = (e) => ui.tLabel.textContent = e.target.files[0]?.name || "No file chosen";

    function processAllFiles() {
        const qFile = ui.csvFile.files[0];
        const tFile = ui.teamFile.files[0];

        if (!qFile) {
            showError("Please upload the Questions CSV at minimum.");
            return;
        }

        Papa.parse(qFile, {
            complete: (resQ) => {
                const qData = processCSV(resQ.data);
                if (!qData) return;
                
                questions = shuffleArray(qData.map(r => ({q: r[0], a: r[1]})));

                if (tFile) {
                    Papa.parse(tFile, {
                        complete: (resT) => {
                            const tData = processCSV(resT.data);
                            teams = tData.map(r => ({ name: r[0], players: r[1] || "", score: 0 }));
                            startGame();
                        }
                    });
                } else {
                    teams = [];
                    startGame();
                }
            },
            error: (err) => showError("Error: " + err.message)
        });
    }

    function processCSV(data) {
        let clean = data.filter(row => row.length >= 1 && row[0]);
        if (ui.skipHeader.checked) clean.shift();
        if (clean.length === 0) { showError("Empty CSV found."); return null; }
        return clean;
    }

    function startGame() {
        currentQuestionIndex = 0;
        saveState();
        renderGame();
    }

    function restoreGame() {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (saved) {
            questions = saved.questions;
            teams = saved.teams;
            currentQuestionIndex = saved.index;
            renderGame();
            playMusicSafe();
        }
    }

    function renderGame() {
        switchScreen('game');
        
        // Setup Scoreboard Side bar
        if (teams.length > 0) {
            updateSidebarUI();
        } else {
            ui.sidebarList.innerHTML = '<div class="text-muted text-center small mt-4">No scoring</div>';
        }

        renderQuestion();
    }

    function renderQuestion() {
        if (currentQuestionIndex >= questions.length) {
            endGame();
            return;
        }
        const q = questions[currentQuestionIndex];
        
        ui.question.style.opacity = 0;
        setTimeout(() => {
            ui.question.textContent = q.q;
            ui.answer.textContent = q.a;
            ui.answer.classList.add('hidden');
            ui.scoringArea.classList.remove('visible'); 
            ui.scoringArea.innerHTML = ''; 

            ui.counter.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
            ui.progress.style.width = `${((currentQuestionIndex + 1) / questions.length) * 100}%`;
            ui.question.style.opacity = 1;
        }, 200);
    }

    function toggleAnswer() {
        const isHidden = ui.answer.classList.contains('hidden');
        if (isHidden) {
            ui.answer.classList.remove('hidden');
            fireConfetti();
            
            if (teams.length > 0) {
                renderScoringButtons();
            }
        } else {
            ui.answer.classList.add('hidden');
            ui.scoringArea.classList.remove('visible');
        }
    }

    function renderScoringButtons() {
        ui.scoringArea.innerHTML = '<span class="text-muted w-100 mb-2">Who got it right?</span>';
        teams.forEach((team, idx) => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm btn-outline-success m-1';
            btn.innerHTML = `<i class="fas fa-plus"></i> ${team.name}`;
            btn.onclick = () => awardPoint(idx);
            ui.scoringArea.appendChild(btn);
        });
        ui.scoringArea.classList.add('visible');
    }

    function awardPoint(teamIdx) {
        teams[teamIdx].score++;
        updateSidebarUI();
        saveState();
        fireConfetti();
    }

    function updateSidebarUI() {
        ui.sidebarList.innerHTML = '';
        const maxScore = Math.max(...teams.map(t => t.score));
        
        // Clone and sort teams for display (Highest score first)
        const sortedTeams = [...teams].sort((a,b) => b.score - a.score);

        sortedTeams.forEach(team => {
            const div = document.createElement('div');
            div.className = 'team-card';
            
            // Leader highlight
            if (team.score === maxScore && maxScore > 0) {
                div.classList.add('leader');
            }
            
            div.innerHTML = `
                <span class="team-name">${team.name}</span>
                <span class="team-players">${team.players}</span>
                <span class="team-score">${team.score}</span>
            `;
            ui.sidebarList.appendChild(div);
        });
    }

    function nextQuestion() {
        if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            saveState();
            renderQuestion();
        } else {
            endGame();
        }
    }
    
    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            saveState();
            renderQuestion();
        }
    }

    function saveState() {
        const state = { questions, teams, index: currentQuestionIndex };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function endGame() {
        switchScreen('end');
        fireConfetti(true);
        localStorage.removeItem(STORAGE_KEY); 

        if (teams.length > 0) {
            const ranked = [...teams].sort((a,b) => b.score - a.score);
            ui.leaderboard.innerHTML = '';
            
            ranked.forEach((team, i) => {
                const div = document.createElement('div');
                div.className = 'leaderboard-item';
                if (i === 0) div.classList.add('winner');
                
                let icon = i === 0 ? 'ðŸ‘‘' : (i === 1 ? 'ðŸ¥ˆ' : (i === 2 ? 'ðŸ¥‰' : `#${i+1}`));
                
                div.innerHTML = `
                    <div>
                        <span class="me-3">${icon}</span>
                        <strong>${team.name}</strong>
                        <div class="small text-muted">${team.players}</div>
                    </div>
                    <span class="badge bg-primary rounded-pill">${team.score} pts</span>
                `;
                ui.leaderboard.appendChild(div);
            });
        } else {
            ui.leaderboard.innerHTML = '<p>Thanks for playing!</p>';
        }
    }

    function resetGame() {
        ui.csvFile.value = '';
        ui.teamFile.value = '';
        ui.qLabel.textContent = 'No file chosen';
        ui.tLabel.textContent = 'No file chosen';
        questions = [];
        teams = [];
        localStorage.removeItem(STORAGE_KEY);
        ui.restoreMsg.innerHTML = '';
        switchScreen('welcome');
    }

    // --- Helpers ---
    function switchScreen(name) {
        Object.values(screens).forEach(el => el.classList.add('d-none-custom'));
        screens[name].classList.remove('d-none-custom');
    }
    
    function showError(msg) {
        ui.error.textContent = msg;
        ui.error.classList.remove('d-none-custom');
        setTimeout(() => ui.error.classList.add('d-none-custom'), 5000);
    }
    
    function changeTheme(themeName) {
        currentTheme = themeName;
        document.body.setAttribute('data-theme', themeName);
        const t = themes[themeName];
        ui.themeIcon1.className = `fas ${t.icon} me-2`;
        ui.themeIcon2.className = `fas ${t.icon2} ms-2`;
        ui.endIcon.className = `fas ${t.endIcon} fa-4x mb-3`;
        ui.themeTitle.textContent = themeName === 'diwali' ? 'Diwali Trivia' : themeName === 'holi' ? 'Holi Trivia' : themeName === 'newyear' ? 'New Year Trivia' : 'Micron Holiday Trivia';
        
        if (t.snow) startSnow(); else stopSnow();
        
        if (t.music) {
            ui.musicBtn.classList.remove('d-none-custom');
            ui.audio.src = t.music;
            if (isMusicPlaying) ui.audio.play().catch(() => {});
        } else {
            ui.musicBtn.classList.add('d-none-custom');
            ui.audio.pause();
        }
    }

    function toggleMusic() {
        if (ui.audio.paused) {
            ui.audio.play().then(() => { isMusicPlaying = true; updateMusicBtnUI(); }).catch(e => console.error(e));
        } else {
            ui.audio.pause();
            isMusicPlaying = false;
            updateMusicBtnUI();
        }
    }

    function updateMusicBtnUI() {
        ui.musicBtn.innerHTML = isMusicPlaying ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
        ui.musicBtn.classList.toggle('btn-light', !isMusicPlaying);
        ui.musicBtn.classList.toggle('btn-success', isMusicPlaying);
    }

    function shuffleArray(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function fireConfetti(big = false) {
        const c = themes[currentTheme].colors;
        if (big) {
            const end = Date.now() + 3000;
            (function f() {
                confetti({ particleCount: 7, angle: 60, spread: 55, origin: {x:0}, colors: c });
                confetti({ particleCount: 7, angle: 120, spread: 55, origin: {x:1}, colors: c });
                if (Date.now() < end) requestAnimationFrame(f);
            })();
        } else {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: c });
        }
    }

    function createSnowflake() {
        const s = document.createElement('div');
        s.innerHTML = 'â„';
        s.className = 'snowflake';
        s.style.left = Math.random()*100 + 'vw';
        s.style.animationDuration = Math.random()*3 + 5 + 's';
        s.style.opacity = Math.random();
        s.style.fontSize = Math.random()*20 + 10 + 'px';
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 8000);
    }

    function startSnow() { if (!snowInterval) snowInterval = setInterval(createSnowflake, 300); }
    function stopSnow() { clearInterval(snowInterval); snowInterval = null; document.querySelectorAll('.snowflake').forEach(e => e.remove()); }

    function downloadTemplates() {
        const qCSV = "data:text/csv;charset=utf-8,Question,Answer\nWhat is red?,A color\nWho is Santa?,St Nick";
        const tCSV = "data:text/csv;charset=utf-8,Team Name,Players\nThe Rudolphs,John & Jane\nSnowmen,Bob & Alice";
        
        const link = document.createElement("a");
        link.href = encodeURI(qCSV); link.download = "questions_template.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        
        setTimeout(() => {
            const link2 = document.createElement("a");
            link2.href = encodeURI(tCSV); link2.download = "teams_template.csv"; document.body.appendChild(link2); link2.click(); document.body.removeChild(link2);
        }, 500);
    }

    document.addEventListener('keydown', (e) => {
        if (screens.game.classList.contains('d-none-custom')) return;
        if (e.key === "ArrowRight" || e.key === " ") {
            if(ui.answer.classList.contains('hidden')) toggleAnswer();
            else nextQuestion();
        }
        if (e.key === "ArrowLeft") prevQuestion();
        if (e.key === "ArrowUp" || e.key === "ArrowDown") toggleAnswer();
    });

    init();
</script>
</body>
</html>